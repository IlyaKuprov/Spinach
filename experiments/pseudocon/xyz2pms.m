% Computes paramagnetic shielding tensor generated by a point mag-
% netic susceptibility centre at the coordinates supplied. Syntax:
%
%                  pms_tensor=ppcs(nxyz,mxyz,chi)
%
% Parameters: 
%
%     chi     - magnetic susceptibility tensor in cubic Angstroms
%               as a 3x3 matrix, or its five unique components 
%               ordered as
%                 
%                [chi(1,1) chi(1,2) chi(1,3) chi(2,2) chi(2,3)]
%
%     nxyz    - coordinates as [x y z] at which the paramagnetic
%               shielding tensor is to be evaluated, in Angstroms.
%
%     sxyz    - susceptibility centre coordinates as [x y z], in 
%               Angstroms.
%
% Output:
% 
%  pms_tensor - predicted paramagnetic shielding tensor, ppm.
%
% Note: the full susceptibility tensor must be supplied, not just 
%       the anisotropic part.
%
% Note: the Zeeman Hamiltonian in Spinach has magnetic field on
%       the left, hence the operand order in D*chi
%
% ilya.kuprov@weizmann.ac.uk
% e.suturina@soton.ac.uk
%
% <https://spindynamics.org/wiki/index.php?title=xyz2pms.m>

function pms_tensor=xyz2pms(nxyz,sxyz,chi)

% Form susceptibility tensor
if numel(chi)==5
    chi=[chi(1)     chi(2)     chi(3); 
         chi(2)     chi(4)     chi(5);
         chi(3)     chi(5) -chi(1)-chi(4)];
end

% Check consistency
grumble(nxyz,sxyz,chi);

% Put the susceptibility at the origin
nxyz=nxyz-sxyz;

% Compute the dipolar matrix
D=3*(nxyz'*nxyz)/norm(nxyz,2)^5-eye(3)/norm(nxyz,2)^3;

% Compute PMS tensor, in ppm
pms_tensor=1e6*(1/(4*pi))*D*chi;

end

% Consistency enforcement
function grumble(nxyz,sxyz,chi)
if (~isnumeric(nxyz))||(numel(nxyz)~=3)||(size(nxyz,1)~=1)||(~isreal(nxyz))
    error('nxyz parameter should be a real row vector with three elements.');
end
if (~isnumeric(sxyz))||(numel(sxyz)~=3)||(size(sxyz,1)~=1)||(~isreal(sxyz))
    error('sxyz parameter should be a real row vector with three elements.');
end
if (~isnumeric(chi))||(size(chi,1)~=3)||(size(chi,2)~=3)||(~isreal(chi))
    error('chi parameter should be a real 3x3 matrix.');
end
end

% It often surprises people to learn that my father's critique 
% of meritocracy was underpinned by his belief that human dif-
% ferences are rooted in genetics, a view many on the left as-
% sociate with neo-liberal economics and the libertarian right.
% [...] The problem, according to him, is that the abilities 
% rewarded in a meritocratic society; namely, exceptional in-
% telligence and drive, are natural gifts rather than learned
% characteristics. So you get plenty of social mobility when 
% the principle first takes hold but, as a meritocratic socie-
% ty matures, this begins to tail off because the offspring of
% those at the top are more likely to have these traits than the
% children of those at the bottom. Of course there are excepti-
% ons. Genetic variation means highly able children are born to
% parents of lower intelligence and vice-versa. But the children
% of the cognitive elite still have the dice loaded in their fa-
% vour, and that remains true even if you eliminate environmen-
% tal advantages. Over time, my father believed, the fluidity 
% and dynamism unleashed by meritocracy would be replaced by a
% rigid caste system underpinned by biology, leading to widesp-
% read discontent.
% 
% Toby Young, the son of Michael Young 
% who coined the term "meritocracy"

